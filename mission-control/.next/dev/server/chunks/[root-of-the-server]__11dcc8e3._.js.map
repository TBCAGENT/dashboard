{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/lukefontaine/.openclaw/workspace/mission-control/src/app/api/airtable/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\n\nconst AIRTABLE_API_KEY = 'pat7OpXE5AOmY2Vsx.a9022cbf9afe775f5f3a27f7900c77049a3d56fa715e34d0821cb7a756c036d7';\nconst BASE_ID = 'appEmn0HdyfUfZ429'; // Buyers Club Control Center\nconst TABLE_NAME = 'Offers';\n\ninterface AirtableRecord {\n  id: string;\n  fields: {\n    Address?: string;\n    'Gross Revenue'?: number;\n    Select?: string;\n    Created?: string;\n    [key: string]: any;\n  };\n}\n\ninterface AirtableResponse {\n  records: AirtableRecord[];\n  offset?: string;\n}\n\nexport async function GET() {\n  try {\n    let allRecords: AirtableRecord[] = [];\n    let offset: string | undefined;\n\n    // Handle pagination to get ALL records\n    do {\n      const url = new URL(`https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}`);\n      if (offset) {\n        url.searchParams.append('offset', offset);\n      }\n\n      const response = await fetch(url.toString(), {\n        headers: {\n          'Authorization': `Bearer ${AIRTABLE_API_KEY}`,\n          'Content-Type': 'application/json'\n        }\n      });\n\n      if (!response.ok) {\n        throw new Error(`HTTP error! status: ${response.status}`);\n      }\n\n      const data: AirtableResponse = await response.json();\n      allRecords = allRecords.concat(data.records);\n      offset = data.offset;\n      \n    } while (offset);\n\n    // Categorize deals by status\n    const dealsByStatus = {\n      'Offer Made': allRecords.filter(record => record.fields.Select === 'Offer Made'),\n      'Pending Contract': allRecords.filter(record => record.fields.Select === 'Pending Contract'),\n      'In Contract': allRecords.filter(record => record.fields.Select === 'In Contract')\n    };\n\n    // Calculate metrics for each category\n    const calculateMetrics = (deals: AirtableRecord[]) => ({\n      count: deals.length,\n      revenue: deals.reduce((sum, record) => sum + (record.fields['Gross Revenue'] || 0), 0),\n      deals: deals.map(record => ({\n        id: record.id,\n        address: record.fields['Address'] || 'Unknown Address',\n        revenue: record.fields['Gross Revenue'] || 0,\n        date: record.fields['Created'],\n        status: record.fields.Select\n      }))\n    });\n\n    const offerMade = calculateMetrics(dealsByStatus['Offer Made']);\n    const pendingContract = calculateMetrics(dealsByStatus['Pending Contract']);\n    const inContract = calculateMetrics(dealsByStatus['In Contract']);\n\n    // Calculate ALL deals added to pipeline in last 24 hours (regardless of current status)\n    const yesterday = new Date();\n    yesterday.setDate(yesterday.getDate() - 1);\n    \n    const last24hDeals = allRecords.filter(record => {\n      const dateField = record.fields['Created']; \n      if (!dateField) return false;\n      const recordDate = new Date(dateField);\n      return recordDate >= yesterday;\n    }).length;\n\n    return NextResponse.json({\n      // Legacy fields for compatibility\n      totalRevenue: inContract.revenue,\n      dealsCount: inContract.count,\n      last24h: last24hDeals,\n      deals: inContract.deals,\n      \n      // New detailed breakdown\n      offerMade,\n      pendingContract,\n      inContract,\n      timestamp: new Date().toISOString()\n    });\n    \n  } catch (error) {\n    console.error('Error fetching Airtable data:', error);\n    return NextResponse.json({\n      error: error instanceof Error ? error.message : 'Unknown error',\n      timestamp: new Date().toISOString()\n    }, { status: 500 });\n  }\n}"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,mBAAmB;AACzB,MAAM,UAAU,qBAAqB,6BAA6B;AAClE,MAAM,aAAa;AAkBZ,eAAe;IACpB,IAAI;QACF,IAAI,aAA+B,EAAE;QACrC,IAAI;QAEJ,uCAAuC;QACvC,GAAG;YACD,MAAM,MAAM,IAAI,IAAI,CAAC,4BAA4B,EAAE,QAAQ,CAAC,EAAE,YAAY;YAC1E,IAAI,QAAQ;gBACV,IAAI,YAAY,CAAC,MAAM,CAAC,UAAU;YACpC;YAEA,MAAM,WAAW,MAAM,MAAM,IAAI,QAAQ,IAAI;gBAC3C,SAAS;oBACP,iBAAiB,CAAC,OAAO,EAAE,kBAAkB;oBAC7C,gBAAgB;gBAClB;YACF;YAEA,IAAI,CAAC,SAAS,EAAE,EAAE;gBAChB,MAAM,IAAI,MAAM,CAAC,oBAAoB,EAAE,SAAS,MAAM,EAAE;YAC1D;YAEA,MAAM,OAAyB,MAAM,SAAS,IAAI;YAClD,aAAa,WAAW,MAAM,CAAC,KAAK,OAAO;YAC3C,SAAS,KAAK,MAAM;QAEtB,QAAS,OAAQ;QAEjB,6BAA6B;QAC7B,MAAM,gBAAgB;YACpB,cAAc,WAAW,MAAM,CAAC,CAAA,SAAU,OAAO,MAAM,CAAC,MAAM,KAAK;YACnE,oBAAoB,WAAW,MAAM,CAAC,CAAA,SAAU,OAAO,MAAM,CAAC,MAAM,KAAK;YACzE,eAAe,WAAW,MAAM,CAAC,CAAA,SAAU,OAAO,MAAM,CAAC,MAAM,KAAK;QACtE;QAEA,sCAAsC;QACtC,MAAM,mBAAmB,CAAC,QAA4B,CAAC;gBACrD,OAAO,MAAM,MAAM;gBACnB,SAAS,MAAM,MAAM,CAAC,CAAC,KAAK,SAAW,MAAM,CAAC,OAAO,MAAM,CAAC,gBAAgB,IAAI,CAAC,GAAG;gBACpF,OAAO,MAAM,GAAG,CAAC,CAAA,SAAU,CAAC;wBAC1B,IAAI,OAAO,EAAE;wBACb,SAAS,OAAO,MAAM,CAAC,UAAU,IAAI;wBACrC,SAAS,OAAO,MAAM,CAAC,gBAAgB,IAAI;wBAC3C,MAAM,OAAO,MAAM,CAAC,UAAU;wBAC9B,QAAQ,OAAO,MAAM,CAAC,MAAM;oBAC9B,CAAC;YACH,CAAC;QAED,MAAM,YAAY,iBAAiB,aAAa,CAAC,aAAa;QAC9D,MAAM,kBAAkB,iBAAiB,aAAa,CAAC,mBAAmB;QAC1E,MAAM,aAAa,iBAAiB,aAAa,CAAC,cAAc;QAEhE,wFAAwF;QACxF,MAAM,YAAY,IAAI;QACtB,UAAU,OAAO,CAAC,UAAU,OAAO,KAAK;QAExC,MAAM,eAAe,WAAW,MAAM,CAAC,CAAA;YACrC,MAAM,YAAY,OAAO,MAAM,CAAC,UAAU;YAC1C,IAAI,CAAC,WAAW,OAAO;YACvB,MAAM,aAAa,IAAI,KAAK;YAC5B,OAAO,cAAc;QACvB,GAAG,MAAM;QAET,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,kCAAkC;YAClC,cAAc,WAAW,OAAO;YAChC,YAAY,WAAW,KAAK;YAC5B,SAAS;YACT,OAAO,WAAW,KAAK;YAEvB,yBAAyB;YACzB;YACA;YACA;YACA,WAAW,IAAI,OAAO,WAAW;QACnC;IAEF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,iCAAiC;QAC/C,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,OAAO,iBAAiB,QAAQ,MAAM,OAAO,GAAG;YAChD,WAAW,IAAI,OAAO,WAAW;QACnC,GAAG;YAAE,QAAQ;QAAI;IACnB;AACF"}}]
}